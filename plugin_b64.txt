##############################################
# YoureWatching Plugin for Enigma2
# Compatible with Python 3.13
# Shows "You're watching..." overlay with
# movie poster and title on channel change
##############################################

from Plugins.Plugin import PluginDescriptor
from Screens.Screen import Screen
from Components.Label import Label
from Components.Pixmap import Pixmap
from Components.ActionMap import ActionMap
from Components.ConfigList import ConfigList, ConfigListScreen
from Components.config import (
    config, ConfigSubsection, ConfigInteger,
    ConfigYesNo, ConfigSelection, getConfigListEntry
)
from enigma import eTimer, ePicLoad, iPlayableService, getDesktop
from Tools.Directories import fileExists
import threading
try:
    import queue
except ImportError:
    import Queue as queue
import os
import time

try:
    from urllib.request import urlopen, Request
    from urllib.parse import quote
except ImportError:
    from urllib2 import urlopen, Request
    from urllib import quote
import json

def my_log(msg):
    try:
        with open("/tmp/watch_debug.log", "a") as f:
            f.write(msg + "\n")
    except: pass


# eEPGCache imported once at module level (not inside a function on every call)
try:
    from enigma import eEPGCache
    _epgcache_available = True
except ImportError:
    _epgcache_available = False

# =====================
# CONFIG
# =====================
config.plugins.youreWatching = ConfigSubsection()
config.plugins.youreWatching.enabled  = ConfigYesNo(default=True)
config.plugins.youreWatching.duration = ConfigInteger(default=6, limits=(3, 30))
config.plugins.youreWatching.position = ConfigSelection(
    default="topleft",
    choices=[
        ("topleft",     "Top Left"),
        ("topright",    "Top Right"),
        ("bottomleft",  "Bottom Left"),
        ("bottomright", "Bottom Right"),
    ]
)

POSTER_PATH  = "/tmp/youre_watching_poster.jpg"
TMDB_API_KEY = "911d7d0ade352ba2bd98c45c96a24cca"
USER_AGENT   = "Mozilla/5.0 (Enigma2 YoureWatchingPlugin/1.0)"

# =====================
# KILL SWITCH (Remote Control)
# To disable plugin: update the Pastebin JSON to {"status": "disabled", "message": "..."}
# =====================
_PLUGIN_ACTIVE = True
_PLUGIN_MSG    = ""

def _check_kill_switch():
    global _PLUGIN_ACTIVE, _PLUGIN_MSG
    try:
        try:
            from urllib.request import urlopen, Request as _Req
        except ImportError:
            from urllib2 import urlopen, Request as _Req
        req = _Req(
            "https://raw.githubusercontent.com/asdrere123-alt/YoureWatching/main/status.json",
            headers={"User-Agent": USER_AGENT}
        )
        r = urlopen(req, timeout=4)
        data = json.loads(r.read().decode("utf-8"))
        if data.get("status", "active") != "active":
            _PLUGIN_ACTIVE = False
            _PLUGIN_MSG = data.get("message", "This plugin has been disabled by the developer.")
    except Exception:
        pass  # if server unreachable, keep plugin running

threading.Thread(target=_check_kill_switch, daemon=True).start()

# =====================
# THREAD -> MAIN THREAD BRIDGE
# _poll_timer is created at module import time on the MAIN thread.
# Background threads only call .start() - never construct new timers.
# =====================
_main_thread_queue  = queue.Queue()
_poll_timer         = eTimer()   # constructed on main thread at import time
_poll_timer_started = False


def _poll_queue():
    """Drains all pending UI calls on the main Enigma2 thread."""
    global _poll_timer_started
    _poll_timer_started = False
    while True:
        try:
            func, args, kwargs = _main_thread_queue.get_nowait()
            try:
                func(*args, **kwargs)
            except Exception as e:
                print("[YoureWatching] main-thread callback error:", e)
        except queue.Empty:
            break


_poll_timer.callback.append(_poll_queue)


def callInMainThread(func, *args, **kwargs):
    """
    Schedule func(*args, **kwargs) on the main Enigma2 thread using Twisted API.
    """
    from twisted.internet import reactor
    reactor.callFromThread(func, *args, **kwargs)


# =====================
# HELPER: get actual screen dimensions (supports 720p and 1080p)
# =====================
def _getScreenSize():
    try:
        sz = getDesktop(0).size()
        return sz.width(), sz.height()
    except Exception:
        return 1280, 720   # safe fallback


# =====================
# OVERLAY SCREEN
# =====================
class YoureWatchingScreen(Screen):

    def _getGeometry(self):
        pos           = config.plugins.youreWatching.position.value
        sw, sh        = _getScreenSize()
        w, h          = 440, 90
        margin        = 40
        if pos == "topleft":
            return margin, margin, w, h
        elif pos == "topright":
            return sw - w - margin, margin, w, h
        elif pos == "bottomleft":
            return margin, sh - h - margin, w, h
        else:  # bottomright
            return sw - w - margin, sh - h - margin, w, h

    def __init__(self, session, title="", posterPath=None):
        # skin MUST be set before Screen.__init__
        x, y, w, h = self._getGeometry()

        self.skin = """
        <screen name="YoureWatchingScreen"
                position="%d,%d" size="%d,%d"
                flags="wfNoBorder" zPosition="99">
            <!-- Sleek semi-transparent dark container -->
            <widget name="background"
                    position="0,0" size="%d,%d"
                    backgroundColor="#BE000000"
                    zPosition="90"/>
            
            <!-- Landscape Backdrop image (16:9 Banner precisely sized) -->
            <widget name="poster"
                    position="10,10" size="124,70"
                    zPosition="95" alphatest="blend"/>
            
            <!-- "You're watching..." small text -->
            <widget name="label_watching"
                    position="145,10" size="280,22"
                    font="Regular;15" foregroundColor="#AAAAAA"
                    transparent="1" valign="top" halign="left"
                    zPosition="95" noWrap="1"/>
            
            <!-- Movie Title text (Cinematic sizing) -->
            <widget name="label_title"
                    position="145,30" size="285,35"
                    font="Regular;24" foregroundColor="#FFFFFF"
                    transparent="1" valign="top" halign="left"
                    zPosition="95" noWrap="1"/>
                    
            <!-- Rating and Year (Premium info) -->
            <widget name="label_rating"
                    position="145,60" size="280,20"
                    font="Regular;16" foregroundColor="#FFD700"
                    transparent="1" valign="top" halign="left"
                    zPosition="95" noWrap="1"/>
        </screen>
        """ % (x, y, w, h, w, h)

        Screen.__init__(self, session)

        # background = Label with empty text; rendered as colored rectangle
        self["background"]     = Label("")
        self["poster"]         = Pixmap()
        self["label_watching"] = Label("You're watching...")
        self["label_title"]    = Label(title or "")
        self["label_rating"]   = Label("")

        self._title      = title
        self._posterPath = posterPath
        self._closed     = False   # guard against double-close

        self.picLoad = ePicLoad()
        self.picLoad.PictureData.get().append(self._paintPosterDone)

        self.hideTimer = eTimer()
        self.hideTimer.callback.append(self._doClose)

        self.onLayoutFinish.append(self._onStart)

    def _onStart(self):
        self._resetTimer()
        if self._posterPath and fileExists(self._posterPath):
            self._loadPoster(self._posterPath)

    def _resetTimer(self):
        try:
            self.hideTimer.stop()
            duration = config.plugins.youreWatching.duration.value * 1000
            self.hideTimer.start(duration, True)
        except Exception as e:
            print("[YoureWatching] _resetTimer error:", e)

    def _loadPoster(self, path):
        try:
            instance = self["poster"].instance
            # Guard: instance can be None if widget not yet fully initialized
            if instance is None:
                return
            sc = instance.size()
            # [width, height, aspect(1=keep ratio), cache(0=off),
            #  desaturate(0=off), rotate(0=off), bg_color]
            self.picLoad.setPara([sc.width(), sc.height(), 1, 0, 0, 0, "#00000000"])
            self.picLoad.startDecode(path)
        except Exception as e:
            print("[YoureWatching] _loadPoster error:", e)

    def _paintPosterDone(self, picInfo=None):
        try:
            if self._closed:
                return
            ptr = self.picLoad.getData()
            if ptr is not None:
                self["poster"].instance.setPixmap(ptr)
        except Exception as e:
            print("[YoureWatching] _paintPosterDone error:", e)

    def _doClose(self):
        if self._closed:
            return
        self._closed = True
        try:
            self.hideTimer.stop()
        except Exception:
            pass
        try:
            self.hide()
        except Exception:
            pass
        try:
            self.close()
        except Exception:
            pass

    def forceClose(self):
        """Called externally (next zap or plugin shutdown)."""
        try:
            self.hideTimer.stop()
        except Exception:
            pass
        self._doClose()


# =====================
# MAIN PLUGIN CLASS
# =====================
class YoureWatchingPlugin:

    def __init__(self, session):
        my_log('[INIT] YoureWatching Plugin started')
        self.session       = session
        self.currentScreen = None
        self._latestTitle  = None

        self.session.nav.event.append(self._onNavEvent)

    def _onNavEvent(self, event):
        my_log('[EVENT] NavEvent triggered: {}'.format(event))
        if not _PLUGIN_ACTIVE:
            return
        if not config.plugins.youreWatching.enabled.value:
            return
        if event == iPlayableService.evStart:
            self._onServiceChanged()

    def _onServiceChanged(self):
        my_log('[SVC] Service Changed called')
        try:
            service = self.session.nav.getCurrentService()
            if not service:
                my_log('[SVC] No service found')
                return
            info = service.info()
            if not info:
                return

            title = ""

            # Priority 1: EPG current event via iServiceInformation.getEvent()
            try:
                evt = info.getEvent(0)
                if evt:
                    title = evt.getEventName() or ""
            except Exception:
                pass

            # Priority 2: eEPGCache direct lookup
            if not title.strip() and _epgcache_available:
                try:
                    epgcache = eEPGCache.getInstance()
                    ref = self.session.nav.getCurrentlyPlayingServiceReference()
                    if ref:
                        evt = epgcache.lookupEventTime(ref, int(time.time()), 0)
                        if evt:
                            title = evt.getEventName() or ""
                except Exception:
                    pass

            # Priority 3: Channel/service name as absolute last resort
            if not title.strip():
                try:
                    title = info.getName() or ""
                except Exception:
                    pass

            title = self._cleanTitle(title.strip())
            if len(title) < 2:
                return

            self._latestTitle = title
            my_log('[FETCH] Cleaned Title to search: {}'.format(title))

            sref = self.session.nav.getCurrentlyPlayingServiceReference()
            
            # INSTANT REACTION: Show the Picon instantly (0ms delay) while TMDB searches in background
            initial_picon = self._getPicon(sref) if sref else None
            # Do an initial fast show
            self._showOverlay(title, initial_picon, is_update=False)

            t = threading.Thread(
                target=self._fetchPoster,
                args=(title, sref),
                daemon=True
            )
            t.start()

        except Exception as e:
            print("[YoureWatching] _onServiceChanged error:", e)

    def _cleanTitle(self, title):
        import re
        # Remove years in parentheses e.g. (2023)
        title = re.sub(r'\(\d{4}\)', '', title)
        # Remove common Arabic/English EPG prefixes and suffixes
        junk_words = [
            r'فيلم\s*', r'مسرحية\s*', r'برنامج\s*', r'مسلسل\s*',
            r'حلقة\s*\d+', r'مباشر\s*', r'حصري\s*', r'HD\s*', r'SD\s*', r'4K\s*',
            r'\[.*?\]', r'\(.*?\)', r'Season\s*\d+', r'Episode\s*\d+',
            r'S\d+E\d+', r'Part\s*\d+', r'الجزء\s*[^ ]+'
        ]
        for word in junk_words:
            title = re.sub(word, '', title, flags=re.IGNORECASE)
        # Clean up extra spaces and hyphens
        title = re.sub(r'[\-:]', ' ', title)
        return title.strip()


    def _getPicon(self, service_ref):
        import os
        from enigma import eServiceReference
        
        # Enigma2 standard picon paths
        search_paths = [
            "/media/usb/picon/",
            "/media/hdd/picon/",
            "/usr/share/enigma2/picon/",
            "/media/ba/picon/" # For some multi-boot systems
        ]
        
        # Format the service reference to match typical Enigma2 picon naming (e.g. 1_0_1_X_X_X...)
        try:
            ref_str = service_ref.toString().replace(':', '_')
            if ref_str.endswith('_'):
                ref_str = ref_str[:-1]
            picon_name = ref_str + ".png"
            
            for path in search_paths:
                full_path = os.path.join(path, picon_name)
                if os.path.exists(full_path):
                    return full_path
                    
            # Fallback for some weird references that add extra params
            ref_parts = ref_str.split('_')
            if len(ref_parts) >= 10:
                short_name = '_'.join(ref_parts[:10]) + ".png"
                for path in search_paths:
                    full_path = os.path.join(path, short_name)
                    if os.path.exists(full_path):
                        return full_path
        except Exception as e:
            my_log('[PICON] Error resolving picon: {}'.format(e))
            
        return None

    def _fetchPoster(self, title, sref=None):
        """Runs in background thread."""
        posterPath = None
        original_search_title = title  # Track original to check for channel zaps
        try:

            # Search universally (no language restriction) to guarantee the Polish/foreign TMDB title hooks
            url = (
                "https://api.themoviedb.org/3/search/multi"
                "?api_key=%s&query=%s&page=1&include_adult=false"
            ) % (TMDB_API_KEY, quote(title, safe=""))

            req      = Request(url, headers={"User-Agent": USER_AGENT})
            response = urlopen(req, timeout=5)
            data     = json.loads(response.read().decode("utf-8"))
            results  = data.get("results", [])

            tmdb_title = title  # Default to the EPG title if TMDB fails
            
            if results:
                # 1. CRITICAL FIX: Sort by popularity DESCENDING to weed out zero-vote local indie films
                results = sorted(results, key=lambda x: x.get("popularity", 0), reverse=True)
                
                # Find the most popular movie that actually has a backdrop
                item = None
                poster = None
                for r in results:
                    if r.get("backdrop_path"):
                        item = r
                        poster = r.get("backdrop_path")
                        break
                        
                # If no backdrop exists at all, just take the #1 most popular entry
                if not item:
                    item = results[0]
                
                # 2. Extract the true English name from the popular entry
                # BUT ONLY IF THE ORIGINAL TITLE IS NOT ARABIC
                import re
                is_arabic = bool(re.search(r'[؀-ۿ]', original_search_title))
                
                extracted_title = (
                    item.get("title") or 
                    item.get("name") or 
                    item.get("original_title") or 
                    item.get("original_name")
                )
                
                if extracted_title and not is_arabic:
                    tmdb_title = extracted_title
                    title = tmdb_title # Replace EPG translation safely
                    my_log('[TMDB] Translated Title: {}'.format(title))
                elif is_arabic:
                    my_log('[TMDB] Skipped translation (Arabic detected)')
                
                # 3. Extract Rating and Year
                rating_text = ""
                vote = item.get("vote_average")
                date = item.get("release_date") or item.get("first_air_date")
                
                if vote and float(vote) > 0:
                    rating_text += "★ {} ".format(round(float(vote), 1))  # Star icon
                if date and len(date) >= 4:
                    rating_text += "({})".format(date[:4])
                
                
                # Fake block to satisfy the rest of the old logic
                for r in results:
                    if r.get("fake_variable_skip"):
                        poster = r.get("backdrop_path")
                        break

                if poster:
                    img_url = "https://image.tmdb.org/t/p/w300" + poster
                    my_log('[TMDB] Found banner: {}'.format(img_url))
                    if os.path.exists(POSTER_PATH):
                        os.remove(POSTER_PATH)
                    img_req      = Request(img_url, headers={"User-Agent": USER_AGENT})
                    img_response = urlopen(img_req, timeout=5)
                    with open(POSTER_PATH, "wb") as f:
                        f.write(img_response.read())
                    if os.path.exists(POSTER_PATH) and os.path.getsize(POSTER_PATH) > 0:
                        posterPath = POSTER_PATH

            # Fallback 3 is removed from thread because the Instant Reaction already handled it.

        except Exception as e:
            print("[YoureWatching] _fetchPoster error:", e)

        # Discard if a newer channel change happened while fetching
        if original_search_title != getattr(self, '_latestTitle', ''):
            return

        # ALWAYS update the UI so the corrected English title shows up, even if there's no poster
        if posterPath or tmdb_title or rating_text:
            callInMainThread(self._showOverlay, title, posterPath, True, rating_text)

    def _showOverlay(self, title, posterPath, is_update=False, rating_text=""):
        """Must only be called on the main Enigma2 thread."""
        my_log('[SHOW] Overlay showing for {}, poster: {}, update: {}'.format(title, posterPath, is_update))
        try:
            if is_update and self.currentScreen is not None:
                # Update existing screen with the new TMDB poster dynamically
                self.currentScreen._title = title
                
                # FORCE the text update. Enigma2 Labels accept setText()
                try:
                    self.currentScreen["label_title"].setText(title)
                    if rating_text:
                        self.currentScreen["label_rating"].setText(rating_text)
                    my_log('[SHOW] Dynamically updated text to: {}'.format(title))
                except Exception as e:
                    my_log('[SHOW] setText exception: {}'.format(e))

                if posterPath and os.path.exists(posterPath):
                    self.currentScreen._loadPoster(posterPath)
                    
                # Reset the close timer so the new info actually stays on screen for a moment
                try:
                    self.currentScreen._resetTimer()
                except Exception as e:
                    my_log('[SHOW] _resetTimer exception: {}'.format(e))
                return

            if self.currentScreen is not None:
                try:
                    self.currentScreen.forceClose()
                except Exception:
                    pass
                self.currentScreen = None

            self.currentScreen = self.session.instantiateDialog(
                YoureWatchingScreen,
                title=title,
                posterPath=posterPath
            )
            self.currentScreen.show()

        except Exception as e:
            print("[YoureWatching] _showOverlay error:", e)

    def destroy(self):
        """Clean up on plugin shutdown."""
        try:
            self.session.nav.event.remove(self._onNavEvent)
        except Exception:
            pass
        if self.currentScreen is not None:
            try:
                self.currentScreen.forceClose()
            except Exception:
                pass
            self.currentScreen = None


# =====================
# SETUP SCREEN
# =====================
class YoureWatchingSetup(Screen, ConfigListScreen):
    # Note: apostrophe in XML attribute must be &apos;
    skin = """
    <screen name="YoureWatchingSetup"
            position="center,center" size="560,310"
            title="You&apos;re Watching - Settings">
        <widget name="config"
                position="10,10" size="540,240"
                scrollbarMode="showOnDemand"/>
        <widget name="key_green"
                position="10,265" size="260,30"
                font="Regular;18" foregroundColor="#00ff00"
                halign="left" transparent="1"/>
        <widget name="key_red"
                position="290,265" size="260,30"
                font="Regular;18" foregroundColor="#ff0000"
                halign="right" transparent="1"/>
    </screen>
    """

    def __init__(self, session):
        my_log('[INIT] YoureWatching Plugin started')
        Screen.__init__(self, session)
        
        self.list = [
            getConfigListEntry("Enable Plugin:",
                               config.plugins.youreWatching.enabled),
            getConfigListEntry("Display Duration (sec):",
                               config.plugins.youreWatching.duration),
            getConfigListEntry("Position:",
                               config.plugins.youreWatching.position),
        ]
        ConfigListScreen.__init__(self, self.list, session=session)

        self["key_green"] = Label("Green: Save")
        self["key_red"]   = Label("Red/Exit: Cancel")
        self["config"] = ConfigList(self.list, session=session)

        # "ok" handled by ConfigList itself to open entry editor
        # green/save = save and close, red/cancel = discard and close
        self["actions"] = ActionMap(
            ["SetupActions", "ColorActions"],
            {
                "green":  self._save,
                "save":   self._save,
                "cancel": self.close,
                "red":    self.close,
            },
            -1
        )

    def _save(self):
        for entry in self.list:
            entry[1].save()
        self.close()


# =====================
# PLUGIN REGISTRATION
# =====================
_plugin_instance = None


def _autoStart(reason, **kwargs):
    global _plugin_instance
    if reason == 0 and "session" in kwargs:
        _plugin_instance = YoureWatchingPlugin(kwargs["session"])
    elif reason == 1:
        if _plugin_instance is not None:
            _plugin_instance.destroy()
        _plugin_instance = None


def _openSetup(session, **kwargs):
    session.open(YoureWatchingSetup)


def Plugins(**kwargs):
    return [
        PluginDescriptor(
            name="You're Watching",
            description="Shows movie title and poster when switching channels",
            where=PluginDescriptor.WHERE_SESSIONSTART,
            fnc=_autoStart,
        ),
        PluginDescriptor(
            name="You're Watching - Settings",
            description="Configure You're Watching plugin",
            where=PluginDescriptor.WHERE_PLUGINMENU,
            fnc=_openSetup,
        ),
    ]
